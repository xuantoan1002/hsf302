<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Shipper Detail - Kaiadmin</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport"/>
    <link rel="icon" th:href="@{/admin/img/kaiadmin/favicon.ico}" type="image/x-icon"/>

    <!-- Fonts and icons -->
    <script th:src="@{/admin/js/plugin/webfont/webfont.min.js}"></script>
    <script>
        WebFont.load({
            google: {families: ["Public Sans:300,400,500,600,700"]},
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons",
                ],
                urls: ["/admin/css/fonts.min.css"],
            },
            active: function () {
                sessionStorage.fonts = true;
            },
        });
    </script>

    <!-- CSS Files -->
    <link rel="stylesheet" th:href="@{/admin/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/plugins.min.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/kaiadmin.min.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/demo.css}"/>
</head>
<body>

<div class="wrapper">
    <div th:replace="/admin/fragment/sidebar :: sidebar"></div>
    <div class="main-panel">
        <div th:replace="/admin/fragment/header :: header"></div>

        <div class="container">
            <div class="page-inner">

                <!-- Page Header -->
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
                    <div>
                        <h3 class="fw-bold mb-3">Shipper Detail</h3>
                        <h6 class="op-7 mb-2">
                            <a th:href="@{/admin/shippers}" class="text-primary">
                                <i class="fa fa-arrow-left me-1"></i>Back to Shipper List
                            </a>
                        </h6>
                    </div>
                    <div class="ms-md-auto py-2 py-md-0">
                        <!-- Start Shipping Form -->
                        <form th:action="@{'/admin/shippers/'+${shipper.getId()}+'/start-shipping'}"
                              method="post" style="display: inline;" id="startShippingForm">
                            <button type="button" class="btn btn-warning me-2"
                                    onclick="confirmStartShipping()">
                                <i class="fa fa-play me-1"></i>Start Shipping
                            </button>
                        </form>

                        <!-- Delete Shipper Form -->
                        <form th:action="@{'/admin/shippers/'+${shipper.getId()}+'/delete'}"
                              method="post" id="deleteForm" style="display: inline;">
                            <button type="button" class="btn btn-danger"
                                    onclick="confirmDelete()">
                                <i class="fa fa-trash me-1"></i>Delete Shipper
                            </button>
                        </form>
                    </div>
                </div>

                <div class="row">
                    <!-- Shipper Information Card -->
                    <div class="col-md-4">
                        <div class="card card-profile">
                            <div class="card-header"
                                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="profile-picture">
                                    <div class="avatar avatar-xl">
                                        <div class="avatar-img rounded-circle bg-white d-flex align-items-center justify-content-center"
                                             style="width: 80px; height: 80px; font-size: 32px; color: #667eea;">
                                            <i class="fas fa-shipping-fast"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="user-profile text-center">
                                    <div class="name" th:text="${shipper.getName()}">Shipper Name</div>
                                    <div class="job" th:text="${'ID: ' + shipper.getId()}">ID: 1</div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Contact Information</div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <strong><i class="fa fa-envelope me-2 text-primary"></i>Email:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span th:text="${shipper.getEmail()}">email@example.com</span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <strong><i class="fa fa-phone me-2 text-success"></i>Phone:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span th:text="${shipper.getPhone()}">+84 123 456 789</span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <strong><i class="fa fa-map-marker-alt me-2 text-danger"></i>Address:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span th:text="${shipper.getAddress()}"></span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <strong><i class="fa fa-calendar me-2 text-info"></i>Joined:</strong>
                                    </div>
                                    <div class="col-8">
                                        <span th:text="${shipper.getToShipperAt()}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Orders History</div>
                            </div>
                            <div class="card-body">
                                <!-- Filter Form -->
                                <form method="get" th:action="@{/admin/shippers/{id}(id=${shipper.getId()})}"
                                      th:object="${request}" id="filterForm" class="mb-4">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="filterStatus" class="form-label">Status</label>
                                            <select class="form-select" id="filterStatus" th:field="*{status}"
                                                    onchange="this.form.submit()">
                                                <option value="CONFIRMED"
                                                        th:selected="${request.status == 'CONFIRMED'}">Confirmed
                                                </option>
                                                <option value="SHIPPING" th:selected="${request.status == 'SHIPPING'}">
                                                    Shipping
                                                </option>
                                                <option value="DELIVERED"
                                                        th:selected="${request.status == 'DELIVERED'}">Delivered
                                                </option>
                                                <option value="COMPLETED"
                                                        th:selected="${request.status == 'COMPLETED'}">Completed
                                                </option>
                                                <option value="CANCELLED"
                                                        th:selected="${request.status == 'CANCELLED'}">Cancelled
                                                </option>
                                                <option value="DELIVERY_FAILED"
                                                        th:selected="${request.status == 'DELIVERY_FAILED'}">Delivery
                                                    Failed
                                                </option>
                                            </select>
                                        </div>

                                        <div class="col-md-3">
                                            <label for="filterCustomerName" class="form-label">Customer Name</label>
                                            <input type="text" class="form-control" id="filterCustomerName"
                                                   placeholder="Enter customer name" th:field="*{customerName}"/>
                                        </div>

                                        <div class="col-md-3">
                                            <label for="filterTotalFrom" class="form-label">Total From</label>
                                            <input type="number" class="form-control" id="filterTotalFrom"
                                                   placeholder="Min amount" th:field="*{totalFrom}" step="0.01"/>
                                        </div>

                                        <div class="col-md-3">
                                            <label for="filterTotalTo" class="form-label">Total To</label>
                                            <input type="number" class="form-control" id="filterTotalTo"
                                                   placeholder="Max amount" th:field="*{totalTo}" step="0.01"/>
                                        </div>

                                        <div class="col-md-3">
                                            <label for="filterSortField" class="form-label">Sort By</label>
                                            <select class="form-select" id="filterSortField" th:field="*{sortField}"
                                                    onchange="this.form.submit()">
                                                <option value="">Default</option>
                                                <option value="createdAt"
                                                        th:selected="${request.sortField == 'createdAt'}">Created Date
                                                </option>
                                                <option value="total" th:selected="${request.sortField == 'total'}">
                                                    Total Amount
                                                </option>
                                            </select>
                                        </div>

                                        <div class="col-md-3">
                                            <label for="filterSortOrder" class="form-label">Sort Order</label>
                                            <select class="form-select" id="filterSortOrder" th:field="*{sortOrder}"
                                                    onchange="this.form.submit()">
                                                <option value="DESC"
                                                        th:selected="${request.sortOrder == 'DESC' or request.sortOrder == null}">
                                                    Newest First
                                                </option>
                                                <option value="ASC" th:selected="${request.sortOrder == 'ASC'}">Oldest
                                                    First
                                                </option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 d-flex align-items-end">
                                            <button type="submit" class="btn btn-primary me-2">
                                                <i class="fa fa-filter me-1"></i>Apply Filters
                                            </button>
                                            <a th:href="@{/admin/shippers/{id}(id=${shipper.getId()})}"
                                               class="btn btn-secondary">
                                                <i class="fa fa-refresh me-1"></i>Reset
                                            </a>
                                        </div>
                                    </div>
                                </form>

                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Total Amount</th>
                                            <th>Status</th>
                                            <th>Order Date</th>
                                            <th>Action</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="order : ${orders}">
                                            <td>
                                                <strong th:text="${'#' + order.getId()}"></strong>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong th:text="${order.getCustomer()?.getName()}"></strong><br>
                                                    <small class="text-muted"
                                                           th:text="${order.getCustomer()?.getPhone()}"></small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-success"
                                                      th:text="${order.getTotal()}"></span>
                                            </td>
                                            <td>
                                                <span th:switch="${order.getStatus()}">
                                                    <span th:case="'PENDING'">Pending</span>
                                                    <span th:case="'CONFIRMED'">Confirmed</span>
                                                    <span th:case="'SHIPPING'">Shipping</span>
                                                    <span th:case="'DELIVERED'">Delivered</span>
                                                    <span th:case="'COMPLETED'">Completed</span>
                                                    <span th:case="'CANCELLED'">Cancelled</span>
                                                    <span th:case="'DELIVERY_FAILED'">Delivery Failed</span>
                                                </span>
                                            </td>
                                            <td>
                                                <span th:text="${order.getCreatedAt()}"></span>
                                            </td>
                                            <td>
                                                <a th:href="@{/admin/orders/{id}(id=${order.getId()})}"
                                                   class="btn btn-info" title="View Order">
                                                    View Order
                                                </a>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- No orders message -->
                                <div th:if="${#lists.isEmpty(orders)}" class="text-center py-4">
                                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No orders found</h5>
                                    <p class="text-muted">No orders match the current filters or this shipper hasn't
                                        been assigned any orders yet.</p>
                                </div>

                                <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-4">
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination pagination-sm mb-0 gap-2">
                                            <!-- Previous -->
                                            <li class="page-item" th:classappend="${!hasPrevious} ? ' disabled'">
                                                <button type="button" class="page-link rounded-pill px-3"
                                                        th:disabled="${!hasPrevious}"
                                                        th:onclick="${hasPrevious} ? 'changePage(' + ${currentPage} + ', \'prev\')' : null">
                                                    &laquo; Prev
                                                </button>
                                            </li>

                                            <!-- Current page display -->
                                            <li class="page-item active">
                                                    <span class="page-link rounded-pill px-3"
                                                          th:text="${currentPage + 1 + '/' + totalPages}"></span>
                                            </li>

                                            <!-- Next -->
                                            <li class="page-item" th:classappend="${!hasNext} ? ' disabled'">
                                                <button type="button" class="page-link rounded-pill px-3"
                                                        th:disabled="${!hasNext}"
                                                        th:onclick="${hasNext} ? 'changePage(' + ${currentPage} + ', \'next\')' : null">
                                                    Next &raquo;
                                                </button>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>

                        <!-- Add Orders Section -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fa fa-plus-circle me-2"></i>Assign Orders to Shipper
                                </div>
                            </div>
                            <div class="card-body">
                                <form th:action="@{'/admin/shippers/' + ${shipper.id} + '/add-orders'}" method="post"
                                      id="addOrdersForm">
                                    <div class="mb-3">
                                        <label class="form-label">Select Orders to Assign:</label>
                                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            <div th:if="${availableOrders != null and !#lists.isEmpty(availableOrders)}">
                                                <div th:each="order : ${availableOrders}" class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox"
                                                           th:value="${order.getId()}"
                                                           th:id="'order_' + ${order.getId()}"
                                                           name="orderIds">
                                                    <label class="form-check-label d-flex justify-content-between align-items-center w-100"
                                                           th:for="'order_' + ${order.getId()}">
                                                        <div>
                                                            <strong th:text="${'#' + order.getId()}"></strong> -
                                                            <span th:text="${order.getCustomer()?.getName()}"></span>
                                                            <br>
                                                            <small class="text-muted"
                                                                   th:text="${'Status: ' + order.getStatus() + ' | Total: ' + order.getTotal()}"></small>
                                                        </div>
                                                        <span class="badge bg-primary"
                                                              th:text="${order.getTotal()}"></span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div th:if="${availableOrders == null or #lists.isEmpty(availableOrders)}"
                                                 class="text-center text-muted py-4">
                                                <i class="fas fa-box-open fa-2x mb-2"></i>
                                                <p>No available orders to assign</p>
                                                <small>All orders are already assigned to shippers or don't meet the
                                                    criteria</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllOrders"
                                                   onchange="toggleAllOrders(this)">
                                            <label class="form-check-label" for="selectAllOrders">
                                                Select All Orders
                                            </label>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-success"
                                                onclick="confirmAddOrders()"
                                                th:disabled="${availableOrders == null or #lists.isEmpty(availableOrders)}">
                                            <i class="fa fa-plus me-1"></i>Assign Selected Orders
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script th:src="@{/admin/js/core/jquery-3.7.1.min.js}"></script>
<script th:src="@{/admin/js/core/popper.min.js}"></script>
<script th:src="@{/admin/js/core/bootstrap.min.js}"></script>
<script th:src="@{/admin/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>
<script th:src="@{/admin/js/plugin/sweetalert/sweetalert.min.js}"></script>
<script th:src="@{/admin/js/kaiadmin.min.js}"></script>
<script>
    // Confirm start shipping function
    function confirmStartShipping() {
        swal({
            title: "Start Shipping?",
            text: "This shipper will be marked as active for shipping orders.",
            icon: "info",
            buttons: {
                confirm: {
                    text: "Yes, start shipping!",
                    className: "btn btn-success",
                },
                cancel: {
                    visible: true,
                    text: "Cancel",
                    className: "btn btn-secondary",
                },
            },
        }).then((confirmed) => {
            if (confirmed) {
                // Submit the form after confirmation
                document.getElementById("startShippingForm").submit();
            }
        });
    }

    // Confirm delete function
    function confirmDelete() {
        swal({
            title: "Are you sure?",
            text: "You won't be able to revert this! All related data will be permanently deleted.",
            type: "warning",
            buttons: {
                confirm: {
                    text: "Yes, delete it!",
                    className: "btn btn-danger",
                },
                cancel: {
                    visible: true,
                    text: "Cancel",
                    className: "btn btn-secondary",
                },
            },
        }).then((confirmed) => {
            if (confirmed) {
                // Submit the delete form
                document.getElementById('deleteForm').submit();
            }
        });
    }

    // Toggle all orders function
    function toggleAllOrders(selectAllCheckbox) {
        const orderCheckboxes = document.querySelectorAll('input[name="orderIds"]');
        orderCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    // Confirm add orders function
    function confirmAddOrders() {
        const selectedOrders = document.querySelectorAll('input[name="orderIds"]:checked');

        if (selectedOrders.length === 0) {
            swal({
                title: "No Orders Selected",
                text: "Please select at least one order to assign to this shipper.",
                icon: "warning",
                button: "OK",
            });
            return;
        }

        swal({
            title: "Assign Orders?",
            text: `Are you sure you want to assign ${selectedOrders.length} order(s) to this shipper?`,
            icon: "question",
            buttons: {
                confirm: {
                    text: "Yes, assign orders!",
                    className: "btn btn-success",
                },
                cancel: {
                    visible: true,
                    text: "Cancel",
                    className: "btn btn-secondary",
                },
            },
        }).then((confirmed) => {
            if (confirmed) {
                document.getElementById("addOrdersForm").submit();
            }
        });
    }
</script>
<script>
    function changePage(page, choice) {
        if (choice === "next") {
            document.getElementById("currentPage").value = page + 1;
        } else if (choice === "prev") {
            document.getElementById("currentPage").value = page - 1;
        } else {
            return;
        }
        document.getElementById("filterForm").submit();
    }
</script>
</body>
</html>